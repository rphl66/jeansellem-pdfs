<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flipbook PDF (net & responsive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #161616;
      --text: #e9e9e9;
      --muted: #9aa0a6;
      --accent: #3ea0ff;
      --gap: 24px;           /* écart entre pages */
    }
    html, body {
      margin:0; padding:0; height:100%; width:100%;
      background: var(--bg); color: var(--text);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .app { height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; }
    .toolbar{
      display:flex; align-items:center; gap:.5rem;
      padding:.6rem .9rem; background:var(--panel);
      border-bottom:1px solid #1f1f1f; position:sticky; top:0; z-index:2;
    }
    .toolbar .spacer{flex:1}
    .btn{
      appearance:none; border:0; border-radius:.6rem;
      padding:.45rem .7rem; color:var(--text); background:#1f1f1f; cursor:pointer;
      transition:.15s ease;
    }
    .btn:hover{background:#242424}
    .btn.primary{background:var(--accent); color:#061321}
    .btn.primary:hover{filter:brightness(1.06)}
    .label{color:var(--muted); margin:0 .35rem}

    .stage{height:100%; overflow:auto; padding:2vh 2vw; display:flex; justify-content:center}
    .spread{display:flex; align-items:center; justify-content:center; gap:var(--gap)}
    canvas{
      display:block; background:#fff; border-radius:.5rem;
      /* ombre moins “floue” */
      box-shadow: 0 8px 26px rgba(0,0,0,.32);
    }
    .status{color:var(--muted); text-align:center; padding:.5rem 1rem; background:var(--panel); border-top:1px solid #1f1f1f}

    @media (max-width: 700px){
      /* on force la simple page sur petit écran pour le confort */
      .force-single .spread{flex-direction:column}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <button class="btn" id="prevBtn" title="Page précédente (←)">←</button>
    <span class="label" id="pageLabel">Page 1 / 1</span>
    <button class="btn" id="nextBtn" title="Page suivante (→)">→</button>

    <span class="spacer"></span>

    <button class="btn" id="zoomOut" title="Zoom -">−</button>
    <span class="label" id="zoomLabel">100%</span>
    <button class="btn" id="zoomIn" title="Zoom +">+</button>

    <span class="spacer"></span>

    <button class="btn" id="toggleSpread" title="Simple/double page">Simple/Double</button>
    <a class="btn primary" id="openPdf" target="_blank" rel="noopener">Ouvrir le PDF</a>
  </div>

  <div class="stage">
    <div class="spread" id="spread">
      <canvas id="page1"></canvas>
      <canvas id="page2" style="display:none"></canvas>
    </div>
  </div>

  <div class="status" id="status">Prêt</div>
</div>

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

  // ======= paramètres URL =======
  const qs = new URLSearchParams(location.search);
  const pdfPath = qs.get("file") || "1971-sandro-adriani.pdf";
  let spread = parseInt(qs.get("spread") || "2", 10);
  let zoom   = parseFloat(qs.get("zoom")   || "1");
  if (![1,2].includes(spread)) spread = 2;
  if (!(zoom > 0)) zoom = 1;

  // ======= DOM =======
  const c1 = document.getElementById("page1");
  const c2 = document.getElementById("page2");
  const spreadEl = document.getElementById("spread");
  const stageEl  = document.querySelector(".stage");
  const pageLabel = document.getElementById("pageLabel");
  const zoomLabel = document.getElementById("zoomLabel");
  const statusEl  = document.getElementById("status");
  const openPdf   = document.getElementById("openPdf");
  openPdf.href = pdfPath;

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const zoomIn  = document.getElementById("zoomIn");
  const zoomOut = document.getElementById("zoomOut");
  const toggleSpread = document.getElementById("toggleSpread");

  // ======= état =======
  let pdf = null;
  let current = 1;

  function setStatus(t){ statusEl.textContent = t; }
  function setZoomLabel(){ zoomLabel.textContent = Math.round(zoom*100) + "%"; }

  // Calcul d'échelle qui garantit que tout rentre en largeur ET hauteur
  function computeFitScale(viewport) {
    const st = getComputedStyle(stageEl);
    const padX = parseFloat(st.paddingLeft) + parseFloat(st.paddingRight);
    const padY = parseFloat(st.paddingTop)  + parseFloat(st.paddingBottom);
    const availW = stageEl.clientWidth  - padX;
    const availH = stageEl.clientHeight - padY;

    const gap = parseFloat(getComputedStyle(spreadEl).gap || "0");
    const perPageAvailW = (spread === 2) ? (availW - gap) / 2 : availW;

    const scaleByW = perPageAvailW / viewport.width;
    const scaleByH = availH / viewport.height;

    return Math.max(0.1, Math.min(scaleByW, scaleByH) * zoom);
  }

  async function renderPage(pageNum, canvas) {
    const page = await pdf.getPage(pageNum);

    // viewport initial (scale = 1)
    const v1 = page.getViewport({ scale: 1 });
    const scale = computeFitScale(v1);
    const v = page.getViewport({ scale });

    // Rendu HiDPI net
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.style.width  = v.width  + "px";
    canvas.style.height = v.height + "px";
    canvas.width  = Math.floor(v.width  * dpr);
    canvas.height = Math.floor(v.height * dpr);

    const ctx = canvas.getContext("2d", { alpha:false });
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    await page.render({ canvasContext: ctx, viewport: v }).promise;
  }

  async function render() {
    if (!pdf) return;
    setStatus("Rendu…");

    const total = pdf.numPages;
    if (current < 1) current = 1;
    if (current > total) current = total;

    if (spread === 2) {
      c2.style.display = (current < total) ? "" : "none";
      await renderPage(current, c1);
      if (current < total) await renderPage(current + 1, c2);
      pageLabel.textContent = `Pages ${current}${current+1<=total?"–"+(current+1):""} / ${total}`;
    } else {
      c2.style.display = "none";
      await renderPage(current, c1);
      pageLabel.textContent = `Page ${current} / ${total}`;
    }

    setZoomLabel();
    setStatus("Prêt");
  }

  // UI
  prevBtn.onclick = () => { current = Math.max(1, current - (spread===2?2:1)); render(); };
  nextBtn.onclick = () => { current = Math.min(pdf.numPages, current + (spread===2?2:1)); render(); };
  zoomIn.onclick  = () => { zoom = Math.min(4,   zoom * 1.1); render(); };
  zoomOut.onclick = () => { zoom = Math.max(.25, zoom / 1.1); render(); };
  toggleSpread.onclick = () => {
    spread = (spread === 2 ? 1 : 2);
    if (spread === 2 && current % 2 === 0) current -= 1; // aligner sur page impaire
    document.body.classList.toggle("force-single", spread === 1);
    render();
  };
  window.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft")  prevBtn.click();
    if (e.key === "ArrowRight") nextBtn.click();
    if (e.key === "+")          zoomIn.click();
    if (e.key === "-")          zoomOut.click();
  });

  let t; window.addEventListener("resize", () => { clearTimeout(t); t = setTimeout(render, 120); });

  // Charge PDF puis rend
  (async () => {
    try{
      setStatus("Chargement du PDF…");
      pdf = await pdfjsLib.getDocument(pdfPath).promise;
      document.body.classList.toggle("force-single", spread === 1);
      await render();
    }catch(err){
      console.error(err);
      setStatus("Erreur de chargement du PDF");
      alert("Impossible de charger le PDF : " + err.message);
    }
  })();
</script>
</body>
</html>
