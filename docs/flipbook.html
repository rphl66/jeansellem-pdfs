<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook PDF</title>

  <!-- PageFlip -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <style>
    :root{ --ink:#111; --muted:#6b7280; --bg:#f8f5f0; --page:#fff; --accent:#0b63ff; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:1400px;margin:0 auto;padding:14px}

    .toolbar{
      display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #e5e7eb;
      border-radius:10px;padding:10px 12px;margin:0 0 10px 0;box-shadow:0 2px 12px rgba(0,0,0,.06)
    }
    .toolbar .title{flex:1;min-width:0;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .toolbar .muted{color:var(--muted);font-weight:500}
    .toolbar button, .toolbar a.btn{
      appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:8px;cursor:pointer;
      padding:6px 10px;font-weight:600
    }
    .toolbar button:hover, .toolbar a.btn:hover{border-color:#d1d5db}
    .sp{flex:1}

    #scene{
      position:relative;background:var(--page);border-radius:12px;overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.12);height:82vh /* sera écrasé par ?vh=... */
    }
    #flipbook{width:100%;height:100%}
    #flipbook .page{background:var(--page)!important}
    #flipbook .page img{
      width:100%;height:100%;object-fit:contain;display:block;background:var(--page);
      image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;
    }
    #flipbook .page__shadow{box-shadow:inset 0 0 25px rgba(0,0,0,.18)}

    .progress{
      position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(248,245,240,.92), rgba(248,245,240,.96));gap:10px
    }
    .progress .bar{width:min(360px,70%);height:8px;border-radius:99px;background:#e5e7eb;overflow:hidden}
    .progress .bar > i{display:block;height:100%;width:0;background:var(--accent);transition:width .25s ease}
    .progress .txt{color:#374151;font-weight:600}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="title" id="tb-title">Flipbook</div>
      <span class="muted" id="tb-count">0 / 0</span>
      <button id="btn-prev" title="Page précédente">◀︎</button>
      <button id="btn-next" title="Page suivante">▶︎</button>
      <div class="sp"></div>
      <button id="btn-zoom-out" title="Qualité –">−</button>
      <button id="btn-zoom-in"  title="Qualité +">＋</button>
      <button id="btn-spread"   title="Basculer 1p/2p">⇆ 1p/2p</button>
      <button id="btn-full"     title="Plein écran">⤢</button>
      <a id="btn-download" class="btn" download>⭳ Télécharger</a>
    </div>

    <div id="scene">
      <div id="flipbook"></div>
      <div id="progress" class="progress">
        <div class="txt" id="pg-text">Préparation…</div>
        <div class="bar"><i id="pg-bar"></i></div>
      </div>
    </div>
  </div>

  <script>
  (async () => {
    // -------- Params d’URL --------
    const params = new URLSearchParams(location.search);
    const setParam = (k,v) => { params.set(k,String(v)); location.search = params.toString(); };

    const file   = params.get("file")   || "1971-sandro-adriani.pdf"; // PDF par défaut
    const cover  = params.get("cover")  || "0";                       // 0 = double-page, 1 = couverture seule
    const spread = params.get("spread") || "2";                       // 1 = une page, 2 = double-page
    const q      = Math.min(6, Math.max(1.5, parseFloat(params.get("q")  || "3.0"))); // qualité de rendu
    const s      = Math.max(1,   parseFloat(params.get("s")  || "1"));   // taille d’affichage
    const vh     = Math.min(98,  Math.max(60, parseFloat(params.get("vh") || "82"))); // hauteur viewer (vh)

    // UI titre + download
    const niceName = decodeURIComponent(file.split("/").pop()).replace(/\+/g," ");
    document.getElementById("tb-title").textContent = niceName;
    const pdfUrl = file.startsWith("http") ? file : new URL(file, location.href).href;
    const dl = document.getElementById("btn-download"); dl.href = pdfUrl; dl.download = niceName;

    // Progress helpers
    const pg = {
      el: document.getElementById("progress"),
      txt: document.getElementById("pg-text"),
      bar: document.getElementById("pg-bar"),
      show(m){ this.el.classList.remove("hidden"); if(m) this.txt.textContent=m; },
      step(i,n){ this.txt.textContent = `Rendu en haute définition… ${i}/${n}`; this.bar.style.width = `${Math.round(i/n*100)}%`; },
      done(){ this.el.classList.add("hidden"); this.bar.style.width="100%"; }
    };
    pg.show("Chargement du PDF…");

    // ---- Charger le PDF ----
    const pdf = await pdfjsLib.getDocument(pdfUrl).promise;

    // ---- Dimensions (avec s & vh) ----
    const scene = document.getElementById("scene");
    scene.style.height = vh + "vh"; // applique la hauteur demandée

    const containerW = scene.clientWidth;
    const pageWBase  = (spread === "1" ? 0.98 : 0.48);
    const pageW = Math.max(420, Math.min(1600, Math.floor(containerW * pageWBase * s)));

    const firstPage = await pdf.getPage(1);
    const base = firstPage.getViewport({ scale: 1 });
    const aspect = base.height / base.width;
    const pageH = Math.round(pageW * aspect);

    // Qualité de rendu (HD)
    const scale = Math.min(
      6, // cap mémoire
      (pageW / base.width) * (window.devicePixelRatio || 1) * q
    );

    // ---- Rendu en images HD ----
    const images = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement("canvas");
      canvas.width = Math.ceil(viewport.width);
      canvas.height = Math.ceil(viewport.height);
      const ctx = canvas.getContext("2d", { alpha:false });
      ctx.imageSmoothingEnabled = true;
      await page.render({ canvasContext: ctx, viewport }).promise;
      images.push(canvas.toDataURL("image/png"));
      pg.step(i, pdf.numPages);
    }

    // ---- Init Flipbook ----
    const flip = new St.PageFlip(document.getElementById("flipbook"), {
      width: pageW,
      height: pageH,
      size: "stretch",
      minWidth: 320,
      minHeight: 420,
      maxWidth: 2400,
      maxHeight: 3400,
      showCover: cover === "1",
      usePortrait: spread === "1",
      flippingTime: 700,
      drawShadow: true,
      maxShadowOpacity: .5,
      mobileScrollSupport: true
    });

    flip.loadFromImages(images);
    pg.done();

    // Compteur + navigation
    const count = document.getElementById("tb-count");
    const refreshCount = () => { count.textContent = `${flip.getCurrentPageIndex()+1} / ${flip.getPageCount()}`; };
    flip.on("flip", refreshCount); refreshCount();
    document.getElementById("btn-prev").onclick = () => flip.flipPrev();
    document.getElementById("btn-next").onclick = () => flip.flipNext();

    // Plein écran
    document.getElementById("btn-full").onclick = async () => {
      if (!document.fullscreenElement) await scene.requestFullscreen().catch(()=>{});
      else await document.exitFullscreen().catch(()=>{});
      setTimeout(()=>location.reload(), 250);
    };

    // Zoom qualité (modifie q)
    document.getElementById("btn-zoom-in").onclick  = () => setParam("q", Math.min(q + 0.5, 6).toFixed(1));
    document.getElementById("btn-zoom-out").onclick = () => setParam("q", Math.max(q - 0.5, 1.5).toFixed(1));

    // Basculer 1p/2p
    document.getElementById("btn-spread").onclick = () => setParam("spread", spread === "1" ? "2" : "1");

    // Reflow simple au resize
    let t; window.addEventListener("resize", () => { clearTimeout(t); t = setTimeout(()=>location.reload(), 250); });
  })().catch(err => {
    console.error(err);
    const el = document.createElement("pre");
    el.style.cssText="max-width:900px;margin:20px auto;color:#b00020;white-space:pre-wrap";
    el.textContent = "Erreur flipbook : " + err.message;
    document.body.appendChild(el);
  });
  </script>
</body>
</html>
