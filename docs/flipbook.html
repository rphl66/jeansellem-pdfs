<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Flipbook PDF (PDF.js léger)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #161616;
      --text: #e9e9e9;
      --muted: #8a8a8a;
      --accent: #3ea0ff;
    }
    html, body {
      margin:0; padding:0; height:100%; width:100%;
      background: var(--bg); color: var(--text);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .app {
      height: 100dvh; width: 100%; display: grid;
      grid-template-rows: auto 1fr auto;
    }
    .toolbar {
      display:flex; align-items:center; gap:.5rem;
      padding:.75rem 1rem; background: var(--panel);
      position:sticky; top:0; z-index:2;
      border-bottom: 1px solid #1f1f1f;
    }
    .toolbar .spacer { flex:1 }
    .btn {
      appearance:none; border:0; border-radius:.6rem;
      padding:.5rem .75rem; color:var(--text); background:#1f1f1f;
      cursor:pointer; transition:.15s ease;
    }
    .btn:hover { background:#282828 }
    .btn:active { transform: translateY(1px) }
    .btn.primary { background: var(--accent); color:#061321 }
    .btn.primary:hover { filter: brightness(1.05); }
    .label { color:var(--muted); margin: 0 .35rem; }

    .stage {
      display:flex; align-items:center; justify-content:center;
      height: 100%; overflow:auto; padding: 2vh 2vw;
    }
    .spread {
      display:flex; gap:2vw; align-items:center; justify-content:center;
    }
    canvas {
      background:#fff; box-shadow: 0 12px 40px rgba(0,0,0,.35);
      border-radius: .5rem;
      max-width: 100%; height: auto;
    }
    .status {
      color: var(--muted); text-align:center; padding: .5rem 1rem;
      background: var(--panel); border-top: 1px solid #1f1f1f;
    }

    @media (max-width: 900px) {
      .spread { gap: 1vw; }
    }
    @media (max-width: 700px) {
      /* Sur mobile on force la simple page pour le confort */
      .force-single .spread { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- barre -->
  <div class="toolbar">
    <button class="btn" id="prevBtn" title="Page précédente (←)">←</button>
    <span class="label" id="pageLabel">Page 1 / 1</span>
    <button class="btn" id="nextBtn" title="Page suivante (→)">→</button>

    <span class="spacer"></span>

    <button class="btn" id="zoomOut" title="Zoom -">−</button>
    <span class="label" id="zoomLabel">100%</span>
    <button class="btn" id="zoomIn" title="Zoom +">+</button>

    <span class="spacer"></span>

    <button class="btn" id="toggleSpread" title="Simple/double page">Simple/Double</button>
    <a class="btn primary" id="openPdf" target="_blank" rel="noopener">Ouvrir le PDF</a>
  </div>

  <!-- rendu -->
  <div class="stage">
    <div class="spread" id="spread">
      <canvas id="page1"></canvas>
      <canvas id="page2" style="display:none"></canvas>
    </div>
  </div>

  <div class="status" id="status">Prêt</div>
</div>

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // Worker
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

  // --------- Params d'URL ----------
  const params = new URLSearchParams(location.search);
  const pdfPath = params.get("file") || "1971-sandro-adriani.pdf";
  let spread = parseInt(params.get("spread") || "2", 10); // 1 ou 2
  let zoom = parseFloat(params.get("zoom") || "1"); // 1.0 = 100%
  if (![1,2].includes(spread)) spread = 2;
  if (!(zoom > 0)) zoom = 1;

  // liens / labels UI
  const pageLabel = document.getElementById("pageLabel");
  const zoomLabel = document.getElementById("zoomLabel");
  const statusEl = document.getElementById("status");
  const openPdf = document.getElementById("openPdf");
  openPdf.href = pdfPath; // lien direct

  // Canvas
  const c1 = document.getElementById("page1");
  const c2 = document.getElementById("page2");
  const spreadWrap = document.getElementById("spread");

  // boutons
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const zoomIn = document.getElementById("zoomIn");
  const zoomOut = document.getElementById("zoomOut");
  const toggleSpread = document.getElementById("toggleSpread");

  // État
  let pdf = null;
  let current = 1;

  function setStatus(msg){ statusEl.textContent = msg; }
  function setZoomLabel(){ zoomLabel.textContent = Math.round(zoom * 100) + "%"; }

  // Rendu d'une page dans un canvas, en respectant la hauteur disponible
  async function renderPage(pageNum, canvas) {
    const page = await pdf.getPage(pageNum);
    const stage = document.querySelector(".stage");
    const availH = stage.clientHeight - 16; // petites marges
    const viewport = page.getViewport({ scale: 1 });
    const scale = (availH / viewport.height) * zoom;

    const v = page.getViewport({ scale });
    const ctx = canvas.getContext("2d", { alpha:false });
    canvas.width = Math.floor(v.width);
    canvas.height = Math.floor(v.height);

    await page.render({ canvasContext: ctx, viewport: v }).promise;
  }

  async function render() {
    if (!pdf) return;
    setStatus("Rendu en cours…");

    const total = pdf.numPages;
    // Empêche de sortir des bornes
    if (current < 1) current = 1;
    if (current > total) current = total;

    // En double-page, on montre current et current+1
    if (spread === 2) {
      c2.style.display = (current < total) ? "" : "none";
      await renderPage(current, c1);
      if (current < total) await renderPage(current + 1, c2);
    } else {
      c2.style.display = "none";
      await renderPage(current, c1);
    }

    pageLabel.textContent =
      spread === 2
        ? `Pages ${current}${current+1 <= total ? "–"+(current+1) : ""} / ${total}`
        : `Page ${current} / ${total}`;

    setZoomLabel();
    setStatus("Prêt");
  }

  // Navigation
  prevBtn.onclick = () => { current = Math.max(1, current - (spread === 2 ? 2 : 1)); render(); };
  nextBtn.onclick = () => { current = Math.min(pdf.numPages, current + (spread === 2 ? 2 : 1)); render(); };
  zoomIn.onclick  = () => { zoom = Math.min(4, zoom * 1.1); render(); };
  zoomOut.onclick = () => { zoom = Math.max(.25, zoom / 1.1); render(); };
  toggleSpread.onclick = () => {
    spread = (spread === 2 ? 1 : 2);
    // En double-page on s'aligne sur une page impaire (début de spread)
    if (spread === 2 && current % 2 === 0) current -= 1;
    document.body.classList.toggle("force-single", spread === 1);
    render();
  };

  // Flèches clavier
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") prevBtn.click();
    if (e.key === "ArrowRight") nextBtn.click();
    if (e.key === "+") zoomIn.click();
    if (e.key === "-") zoomOut.click();
  });

  // Redimensionnement
  let resizeTo;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTo);
    resizeTo = setTimeout(render, 150);
  });

  // Charge le PDF (chemin relatif depuis GH Pages)
  (async () => {
    try {
      setStatus("Chargement du PDF…");
      pdf = await pdfjsLib.getDocument(pdfPath).promise;
      setStatus("PDF chargé");
      document.body.classList.toggle("force-single", spread === 1);
      await render();
    } catch (err) {
      console.error(err);
      setStatus("Erreur de chargement du PDF");
      alert("Impossible de charger le PDF : " + err.message);
    }
  })();
</script>
</body>
</html>
